{% extends "base.html" %}

{% block title %}Dashboard - Yaad{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-white">Welcome back, {{ user.username }}</h1>
        <p class="text-dark-400 mt-1">Track your films, books, and videos all in one place.</p>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-8">
        <!-- Films - Blue -->
        <a href="/catalogue?type=film" class="group bg-dark-900 rounded-xl border border-dark-800 p-4 hover:bg-blue-500/10 hover:border-blue-500/50 transition-all duration-200">
            <div class="flex flex-col items-center text-center">
                <div class="w-10 h-10 bg-dark-800 rounded-lg flex items-center justify-center mb-2 group-hover:bg-blue-500/20 transition-colors">
                    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"/>
                    </svg>
                </div>
                <p class="text-xl font-bold text-white">{{ stats.films }}</p>
                <p class="text-dark-400 text-xs">Films</p>
            </div>
        </a>

        <!-- Series - Cyan -->
        <a href="/catalogue?type=series" class="group bg-dark-900 rounded-xl border border-dark-800 p-4 hover:bg-cyan-500/10 hover:border-cyan-500/50 transition-all duration-200">
            <div class="flex flex-col items-center text-center">
                <div class="w-10 h-10 bg-dark-800 rounded-lg flex items-center justify-center mb-2 group-hover:bg-cyan-500/20 transition-colors">
                    <svg class="w-5 h-5 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
                <p class="text-xl font-bold text-white">{{ stats.series }}</p>
                <p class="text-dark-400 text-xs">Series</p>
            </div>
        </a>

        <!-- Books - Green -->
        <a href="/catalogue?type=book" class="group bg-dark-900 rounded-xl border border-dark-800 p-4 hover:bg-green-500/10 hover:border-green-500/50 transition-all duration-200">
            <div class="flex flex-col items-center text-center">
                <div class="w-10 h-10 bg-dark-800 rounded-lg flex items-center justify-center mb-2 group-hover:bg-green-500/20 transition-colors">
                    <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                </div>
                <p class="text-xl font-bold text-white">{{ stats.books }}</p>
                <p class="text-dark-400 text-xs">Books</p>
            </div>
        </a>

        <!-- Videos - Red -->
        <a href="/catalogue?type=youtube" class="group bg-dark-900 rounded-xl border border-dark-800 p-4 hover:bg-red-500/10 hover:border-red-500/50 transition-all duration-200">
            <div class="flex flex-col items-center text-center">
                <div class="w-10 h-10 bg-dark-800 rounded-lg flex items-center justify-center mb-2 group-hover:bg-red-500/20 transition-colors">
                    <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <p class="text-xl font-bold text-white">{{ stats.videos }}</p>
                <p class="text-dark-400 text-xs">Videos</p>
            </div>
        </a>

        <!-- Podcasts - Purple -->
        <a href="/catalogue?type=podcast" class="group bg-dark-900 rounded-xl border border-dark-800 p-4 hover:bg-purple-500/10 hover:border-purple-500/50 transition-all duration-200">
            <div class="flex flex-col items-center text-center">
                <div class="w-10 h-10 bg-dark-800 rounded-lg flex items-center justify-center mb-2 group-hover:bg-purple-500/20 transition-colors">
                    <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                    </svg>
                </div>
                <p class="text-xl font-bold text-white">{{ stats.podcasts }}</p>
                <p class="text-dark-400 text-xs">Podcasts</p>
            </div>
        </a>

        <!-- Shows - Pink -->
        <a href="/catalogue?type=show" class="group bg-dark-900 rounded-xl border border-dark-800 p-4 hover:bg-pink-500/10 hover:border-pink-500/50 transition-all duration-200">
            <div class="flex flex-col items-center text-center">
                <div class="w-10 h-10 bg-dark-800 rounded-lg flex items-center justify-center mb-2 group-hover:bg-pink-500/20 transition-colors">
                    <svg class="w-5 h-5 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                    </svg>
                </div>
                <p class="text-xl font-bold text-white">{{ stats.shows }}</p>
                <p class="text-dark-400 text-xs">Shows</p>
            </div>
        </a>

        <!-- In Progress - Yellow -->
        <a href="/catalogue?status=in_progress" class="group bg-dark-900 rounded-xl border border-dark-800 p-4 hover:bg-yellow-500/10 hover:border-yellow-500/50 transition-all duration-200">
            <div class="flex flex-col items-center text-center">
                <div class="w-10 h-10 bg-dark-800 rounded-lg flex items-center justify-center mb-2 group-hover:bg-yellow-500/20 transition-colors">
                    <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <p class="text-xl font-bold text-white">{{ stats.in_progress }}</p>
                <p class="text-dark-400 text-xs">In Progress</p>
            </div>
        </a>
    </div>

    {% if stats.total == 0 %}
    <!-- Empty State -->
    <div class="bg-dark-900 rounded-xl border border-dark-800 p-12 text-center">
        <div class="w-20 h-20 mx-auto bg-dark-800 rounded-full flex items-center justify-center mb-4">
            <svg class="w-10 h-10 text-dark-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
            </svg>
        </div>
        <h2 class="text-xl font-semibold text-white mb-2">Your library is empty</h2>
        <p class="text-dark-400 mb-6 max-w-md mx-auto">
            Start building your personal media library by adding films, books, or YouTube videos.
        </p>
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <a href="/add"
               class="inline-flex items-center justify-center px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Add Media
            </a>
            <a href="/settings"
               class="inline-flex items-center justify-center px-6 py-3 bg-dark-800 hover:bg-dark-700 text-white font-medium rounded-lg border border-dark-700 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Settings
            </a>
        </div>
    </div>
    {% else %}
    <!-- Up Next Slider -->
    {% if unfinished_media %}
    <div class="mt-8" x-data="upNextSlider()">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <h2 class="text-xl font-semibold text-white">Up Next</h2>
                <span class="px-2.5 py-1 bg-primary-500/20 text-primary-400 text-xs font-medium rounded-full">
                    {{ unfinished_media|length }} items
                </span>
            </div>
            <div class="flex items-center gap-2">
                <button type="button"
                        @click="scrollLeft()"
                        :class="canScrollLeft ? 'bg-dark-800 hover:bg-dark-700 text-dark-400 hover:text-white' : 'bg-dark-900 text-dark-700 cursor-not-allowed'"
                        class="p-2 rounded-lg transition-all duration-200 group">
                    <svg class="w-5 h-5 transition-transform duration-200 group-hover:-translate-x-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <button type="button"
                        @click="scrollRight()"
                        :class="canScrollRight ? 'bg-dark-800 hover:bg-dark-700 text-dark-400 hover:text-white' : 'bg-dark-900 text-dark-700 cursor-not-allowed'"
                        class="p-2 rounded-lg transition-all duration-200 group">
                    <svg class="w-5 h-5 transition-transform duration-200 group-hover:translate-x-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Slider Container with gradient edges -->
        <div class="relative">
            <!-- Left fade gradient -->
            <div class="absolute left-0 top-0 bottom-4 w-12 bg-gradient-to-r from-dark-950 to-transparent z-10 pointer-events-none transition-opacity duration-300"
                 :class="canScrollLeft ? 'opacity-100' : 'opacity-0'"></div>

            <!-- Right fade gradient -->
            <div class="absolute right-0 top-0 bottom-4 w-12 bg-gradient-to-l from-dark-950 to-transparent z-10 pointer-events-none transition-opacity duration-300"
                 :class="canScrollRight ? 'opacity-100' : 'opacity-0'"></div>

            <div x-ref="slider"
                 @scroll="updateScrollState()"
                 @mousedown="startDrag($event)"
                 @mousemove="onDrag($event)"
                 @mouseup="endDrag()"
                 @mouseleave="endDrag()"
                 :class="isDragging ? 'cursor-grabbing' : 'cursor-grab'"
                 class="flex gap-4 overflow-x-auto pb-4 snap-x snap-mandatory hide-scrollbar select-none"
                 style="-webkit-overflow-scrolling: touch;">
                {% for media in unfinished_media %}
                <a href="/media/{{ media.id }}"
                   @click="if (wasDragging) $event.preventDefault()"
                   class="slider-card flex-shrink-0 snap-start group relative"
                   style="width: 280px;">
                    <div class="bg-dark-900 rounded-xl overflow-hidden hover:shadow-xl hover:shadow-primary-500/10">
                        <!-- Cover Image -->
                        <div class="aspect-[16/10] relative overflow-hidden bg-dark-900">
                            {% if media.cover_url %}
                            <img src="{{ media.cover_url }}"
                                 alt="{{ media.title }}"
                                 class="w-full h-full object-cover
                                    {% if media.type.value in ['film', 'series'] %}object-[center_20%]{% elif media.type.value == 'book' %}object-top{% elif media.type.value in ['youtube', 'podcast'] %}object-[center_30%]{% else %}object-center{% endif %}"
                                 loading="lazy"
                                 draggable="false"
                                 data-smart-crop>
                            {% else %}
                            <div class="w-full h-full flex items-center justify-center
                                {% if media.type.value == 'film' %}bg-gradient-to-br from-blue-600 to-blue-900
                                {% elif media.type.value == 'series' %}bg-gradient-to-br from-cyan-600 to-cyan-900
                                {% elif media.type.value == 'book' %}bg-gradient-to-br from-green-600 to-green-900
                                {% elif media.type.value == 'youtube' %}bg-gradient-to-br from-red-600 to-red-900
                                {% elif media.type.value == 'podcast' %}bg-gradient-to-br from-purple-600 to-purple-900
                                {% elif media.type.value == 'show' %}bg-gradient-to-br from-pink-600 to-pink-900
                                {% else %}bg-gradient-to-br from-primary-600 to-primary-900{% endif %}">
                                <span class="text-5xl font-bold text-white/80 transform group-hover:scale-110 transition-transform duration-500">{{ media.title[0]|upper }}</span>
                            </div>
                            {% endif %}

                            <!-- Gradient Overlay -->
                            <div class="absolute inset-0 bg-gradient-to-t from-dark-950 via-dark-950/20 to-transparent opacity-80 group-hover:opacity-90 transition-opacity duration-300"></div>

                            <!-- Type Badge -->
                            <div class="absolute top-3 left-3 transform transition-all duration-300 group-hover:translate-y-0 group-hover:opacity-100">
                                {% if media.type.value == 'film' %}
                                <span class="px-2.5 py-1 bg-blue-500/90 backdrop-blur-sm text-xs font-semibold rounded-md text-white shadow-lg">Film</span>
                                {% elif media.type.value == 'series' %}
                                <span class="px-2.5 py-1 bg-cyan-500/90 backdrop-blur-sm text-xs font-semibold rounded-md text-white shadow-lg">Series</span>
                                {% elif media.type.value == 'book' %}
                                <span class="px-2.5 py-1 bg-green-500/90 backdrop-blur-sm text-xs font-semibold rounded-md text-white shadow-lg">Book</span>
                                {% elif media.type.value == 'youtube' %}
                                <span class="px-2.5 py-1 bg-red-500/90 backdrop-blur-sm text-xs font-semibold rounded-md text-white shadow-lg">Video</span>
                                {% elif media.type.value == 'podcast' %}
                                <span class="px-2.5 py-1 bg-purple-500/90 backdrop-blur-sm text-xs font-semibold rounded-md text-white shadow-lg">Podcast</span>
                                {% elif media.type.value == 'show' %}
                                <span class="px-2.5 py-1 bg-pink-500/90 backdrop-blur-sm text-xs font-semibold rounded-md text-white shadow-lg">Show</span>
                                {% endif %}
                            </div>

                            <!-- Status Badge -->
                            <div class="absolute top-3 right-3">
                                {% if media.status.value == 'in_progress' %}
                                <span class="px-2.5 py-1 bg-yellow-500/90 backdrop-blur-sm text-xs font-semibold rounded-md text-white shadow-lg flex items-center gap-1.5">
                                    <span class="w-1.5 h-1.5 bg-white rounded-full animate-pulse"></span>
                                    In Progress
                                </span>
                                {% elif media.status.value == 'to_consume' %}
                                <span class="px-2.5 py-1 bg-dark-800/90 backdrop-blur-sm text-xs font-semibold rounded-md text-dark-200 shadow-lg">
                                    To Watch
                                </span>
                                {% endif %}
                            </div>

                            <!-- Play/Continue Overlay (on hover) -->
                            <div class="absolute inset-0 bg-dark-950/60 opacity-0 group-hover:opacity-100 transition-all duration-500 flex items-center justify-center">
                                <div class="w-16 h-16 bg-primary-500 rounded-full flex items-center justify-center shadow-2xl transform scale-50 opacity-0 group-hover:scale-100 group-hover:opacity-100 transition-all duration-500 ease-out hover:bg-primary-400">
                                    {% if media.status.value == 'in_progress' %}
                                    <svg class="w-7 h-7 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                    {% else %}
                                    <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                    </svg>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="p-4">
                            <h3 class="text-white font-semibold line-clamp-1 group-hover:text-primary-400 transition-colors duration-300">
                                {{ media.title }}
                            </h3>
                            <div class="flex items-center justify-between mt-2">
                                <p class="text-dark-400 text-sm">
                                    {% if media.year %}{{ media.year }}{% endif %}
                                    {% if media.duration_minutes %}
                                    <span class="text-dark-600 mx-1">&bull;</span>
                                    {{ media.duration_minutes | format_duration }}
                                    {% endif %}
                                    {% if media.page_count %}
                                    <span class="text-dark-600 mx-1">&bull;</span>
                                    {{ media.page_count }} pages
                                    {% endif %}
                                </p>
                                {% if media.rating %}
                                <div class="flex items-center gap-1 bg-dark-800 px-2 py-0.5 rounded transform group-hover:scale-105 transition-transform duration-300">
                                    <svg class="w-3.5 h-3.5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                    <span class="text-xs text-white font-medium">{{ media.rating }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recently Added -->
    <div class="mt-8">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-white">Recently Added</h2>
            <a href="/catalogue" class="text-primary-500 hover:text-primary-400 text-sm font-medium">
                View all
            </a>
        </div>
        {% if recent_media %}
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
            {% for media in recent_media %}
            <a href="/media/{{ media.id }}" class="group">
                <div class="bg-dark-900 rounded-lg border border-dark-800 overflow-hidden hover:border-primary-500 transition-colors">
                    <!-- Adaptive aspect ratio based on media type -->
                    <div class="{% if media.type.value in ['youtube', 'podcast'] %}aspect-video{% else %}aspect-[2/3]{% endif %} bg-dark-800 relative">
                        {% if media.cover_url %}
                        <img src="{{ media.cover_url }}"
                             alt="{{ media.title }}"
                             class="w-full h-full object-cover media-cover"
                             loading="lazy">
                        {% else %}
                        <!-- Letter placeholder with type-specific gradient -->
                        <div class="w-full h-full flex items-center justify-center
                            {% if media.type.value == 'film' %}bg-gradient-to-br from-blue-600 to-blue-800
                            {% elif media.type.value == 'series' %}bg-gradient-to-br from-cyan-600 to-cyan-800
                            {% elif media.type.value == 'book' %}bg-gradient-to-br from-green-600 to-green-800
                            {% elif media.type.value == 'youtube' %}bg-gradient-to-br from-red-600 to-red-800
                            {% elif media.type.value == 'podcast' %}bg-gradient-to-br from-purple-600 to-purple-800
                            {% elif media.type.value == 'show' %}bg-gradient-to-br from-pink-600 to-pink-800
                            {% else %}bg-gradient-to-br from-primary-600 to-primary-800{% endif %}">
                            <span class="text-4xl font-bold text-white/90">{{ media.title[0]|upper }}</span>
                        </div>
                        {% endif %}

                        <!-- Type badge -->
                        <div class="absolute top-2 left-2">
                            {% if media.type.value == 'film' %}
                            <span class="px-2 py-1 bg-blue-500/80 text-xs font-medium rounded text-white">Film</span>
                            {% elif media.type.value == 'series' %}
                            <span class="px-2 py-1 bg-cyan-500/80 text-xs font-medium rounded text-white">Series</span>
                            {% elif media.type.value == 'book' %}
                            <span class="px-2 py-1 bg-green-500/80 text-xs font-medium rounded text-white">Book</span>
                            {% elif media.type.value == 'youtube' %}
                            <span class="px-2 py-1 bg-red-500/80 text-xs font-medium rounded text-white">Video</span>
                            {% elif media.type.value == 'podcast' %}
                            <span class="px-2 py-1 bg-purple-500/80 text-xs font-medium rounded text-white">Podcast</span>
                            {% elif media.type.value == 'show' %}
                            <span class="px-2 py-1 bg-pink-500/80 text-xs font-medium rounded text-white">Show</span>
                            {% endif %}
                        </div>

                        {% if media.rating %}
                        <div class="absolute bottom-2 left-2 flex items-center bg-dark-900/80 px-2 py-1 rounded">
                            <svg class="w-4 h-4 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                            </svg>
                            <span class="text-sm text-white">{{ media.rating }}/5</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="p-3">
                        <h3 class="text-sm font-medium text-white line-clamp-2 group-hover:text-primary-400 transition-colors">
                            {{ media.title }}
                        </h3>
                        <p class="text-xs text-dark-400 mt-1">
                            {% if media.year %}{{ media.year }}{% endif %}
                        </p>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-dark-900 rounded-xl border border-dark-800 p-6 text-center">
            <p class="text-dark-400">No media added yet.</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<style>
    .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
        /* Force GPU compositing layer */
        transform: translate3d(0, 0, 0);
        -webkit-transform: translate3d(0, 0, 0);
        /* Optimize for scrolling */
        contain: layout style;
    }
    .hide-scrollbar::-webkit-scrollbar {
        display: none;
    }

    /* Fix potential white line from subpixel rendering */
    .slider-card img {
        vertical-align: bottom;
        display: block;
        /* Prevent image repaints */
        content-visibility: auto;
    }

    /* GPU acceleration for smooth animations */
    .slider-card {
        will-change: transform, opacity;
        transform: translate3d(0, 0, 0);
        -webkit-transform: translate3d(0, 0, 0);
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        /* Promote to own layer */
        isolation: isolate;
        /* Optimize repaints */
        contain: layout style paint;
    }

    /* Card hover transitions - use transform only for best perf */
    .slider-card > div {
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1),
                    box-shadow 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        transform: translate3d(0, 0, 0);
        will-change: transform;
    }

    .slider-card:hover > div {
        transform: translate3d(0, -8px, 0);
    }

    /* Image zoom on hover - GPU accelerated */
    .slider-card img {
        transition: transform 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
        transform: translate3d(0, 0, 0) scale(1);
        will-change: transform;
    }

    .slider-card:hover img {
        transform: translate3d(0, 0, 0) scale(1.1);
    }

    /* Entry animation */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translate3d(20px, 0, 0);
        }
        to {
            opacity: 1;
            transform: translate3d(0, 0, 0);
        }
    }

    .slider-card {
        animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }

    {% for i in range(unfinished_media|length) %}
    .slider-card:nth-child({{ i + 1 }}) {
        animation-delay: {{ i * 0.04 }}s;
    }
    {% endfor %}
</style>

<script>
// Smart crop: ajuste le positionnement selon le ratio de l'image
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('img[data-smart-crop]').forEach(img => {
        img.onload = function() {
            const imgRatio = this.naturalWidth / this.naturalHeight;

            if (imgRatio < 0.8) {
                this.style.objectPosition = 'center 15%';
            } else if (imgRatio < 1.2) {
                this.style.objectPosition = 'center 25%';
            } else {
                this.style.objectPosition = 'center center';
            }
        };

        if (img.complete && img.naturalWidth) {
            img.onload();
        }
    });
});

function upNextSlider() {
    return {
        isDragging: false,
        wasDragging: false,
        startX: 0,
        scrollLeftStart: 0,
        canScrollLeft: false,
        canScrollRight: true,
        velocity: 0,
        lastX: 0,
        lastTime: 0,
        animationId: null,
        currentScroll: 0,
        targetScroll: 0,
        isAnimating: false,

        // Spring physics parameters for ultra-smooth animation
        springStiffness: 0.08,  // Lower = smoother, slower
        springDamping: 0.85,    // Higher = less oscillation
        springVelocity: 0,

        init() {
            this.$nextTick(() => {
                const slider = this.$refs.slider;
                this.currentScroll = slider.scrollLeft;
                this.targetScroll = this.currentScroll;
                this.updateScrollState();

                // Start the continuous animation loop
                this.startAnimationLoop();
            });
        },

        updateScrollState() {
            const slider = this.$refs.slider;
            if (!slider) return;

            this.canScrollLeft = slider.scrollLeft > 10;
            this.canScrollRight = slider.scrollLeft < (slider.scrollWidth - slider.clientWidth - 10);
        },

        scrollLeft() {
            const slider = this.$refs.slider;
            if (!slider) return;

            const cardWidth = 280 + 16;
            this.targetScroll = Math.max(0, this.currentScroll - cardWidth * 2);
            this.springVelocity = 0; // Reset spring velocity for button clicks
        },

        scrollRight() {
            const slider = this.$refs.slider;
            if (!slider) return;

            const cardWidth = 280 + 16;
            const maxScroll = slider.scrollWidth - slider.clientWidth;
            this.targetScroll = Math.min(maxScroll, this.currentScroll + cardWidth * 2);
            this.springVelocity = 0;
        },

        // Continuous animation loop - always running for maximum smoothness
        startAnimationLoop() {
            let lastTime = performance.now();

            const loop = (currentTime) => {
                const deltaTime = Math.min(currentTime - lastTime, 32); // Cap at ~30fps minimum
                lastTime = currentTime;

                const slider = this.$refs.slider;
                if (!slider) {
                    this.animationId = requestAnimationFrame(loop);
                    return;
                }

                // Spring physics calculation
                const displacement = this.targetScroll - this.currentScroll;
                const springForce = displacement * this.springStiffness;

                // Apply spring force to velocity
                this.springVelocity += springForce;
                this.springVelocity *= this.springDamping;

                // Apply velocity to position (frame-rate independent)
                const movement = this.springVelocity * (deltaTime / 16.67);
                this.currentScroll += movement;

                // Update DOM only if there's meaningful movement
                if (Math.abs(movement) > 0.01 || Math.abs(displacement) > 0.5) {
                    slider.scrollLeft = this.currentScroll;
                    this.updateScrollState();
                }

                // Snap to target when very close
                if (Math.abs(displacement) < 0.1 && Math.abs(this.springVelocity) < 0.01) {
                    this.currentScroll = this.targetScroll;
                    slider.scrollLeft = this.targetScroll;
                    this.springVelocity = 0;
                }

                this.animationId = requestAnimationFrame(loop);
            };

            this.animationId = requestAnimationFrame(loop);
        },

        startDrag(e) {
            if (e.button !== 0) return;

            this.isDragging = true;
            this.wasDragging = false;
            this.startX = e.pageX;
            this.scrollLeftStart = this.currentScroll;
            this.lastX = e.pageX;
            this.lastTime = performance.now();
            this.velocity = 0;

            // Reset spring velocity when starting drag
            this.springVelocity = 0;
        },

        onDrag(e) {
            if (!this.isDragging) return;

            e.preventDefault();
            const x = e.pageX;
            const walk = (this.startX - x) * 1.5; // Increased responsiveness

            // Calculate velocity with smoothing
            const now = performance.now();
            const dt = now - this.lastTime;
            if (dt > 0 && dt < 50) {
                const instantVelocity = (this.lastX - x) / dt;
                this.velocity = this.velocity * 0.6 + instantVelocity * 0.4;
            }
            this.lastX = x;
            this.lastTime = now;

            // Direct update for immediate feedback
            const newScroll = this.scrollLeftStart + walk;
            this.currentScroll = newScroll;
            this.targetScroll = newScroll;
            this.$refs.slider.scrollLeft = newScroll;

            if (Math.abs(walk) > 5) {
                this.wasDragging = true;
            }

            this.updateScrollState();
        },

        endDrag() {
            if (!this.isDragging) return;

            this.isDragging = false;

            // Apply momentum as spring target
            if (Math.abs(this.velocity) > 0.2) {
                const slider = this.$refs.slider;
                const maxScroll = slider.scrollWidth - slider.clientWidth;

                // Project where the momentum would take us
                const momentumDistance = this.velocity * 300; // Momentum multiplier
                let projected = this.currentScroll + momentumDistance;

                // Clamp to bounds
                projected = Math.max(0, Math.min(maxScroll, projected));

                // Set as spring target - the spring will smoothly animate to it
                this.targetScroll = projected;

                // Give initial velocity to the spring for more natural feel
                this.springVelocity = this.velocity * 8;
            }

            setTimeout(() => {
                this.wasDragging = false;
            }, 50);
        }
    }
}
</script>
{% endblock %}
