{% extends "base.html" %}

{% block title %}Statistics - Yaad{% endblock %}

{% block head %}
<!-- Chart.js for visualizations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-10 xl:px-12 py-5" x-data="statsPage({{ stats | tojson }})">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-white">Statistics</h1>
        <p class="text-dark-400 mt-1">Your media consumption at a glance.</p>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <!-- Total Media -->
        <div class="bg-dark-900 rounded-xl border border-dark-800 p-5">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-primary-500/20 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-white">{{ stats.total_media }}</p>
                    <p class="text-dark-400 text-sm">Total Media</p>
                </div>
            </div>
        </div>

        <!-- Finished -->
        <div class="bg-dark-900 rounded-xl border border-dark-800 p-5">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-white">{{ stats.total_finished }}</p>
                    <p class="text-dark-400 text-sm">Finished</p>
                </div>
            </div>
        </div>

        <!-- In Progress -->
        <div class="bg-dark-900 rounded-xl border border-dark-800 p-5">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-yellow-500/20 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-white">{{ stats.total_in_progress }}</p>
                    <p class="text-dark-400 text-sm">In Progress</p>
                </div>
            </div>
        </div>

        <!-- Average Rating -->
        <div class="bg-dark-900 rounded-xl border border-dark-800 p-5">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-yellow-500/20 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-white">{% if stats.average_rating %}{{ "%.1f"|format(stats.average_rating) }}{% else %}-{% endif %}</p>
                    <p class="text-dark-400 text-sm">Avg Rating</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Stats Row -->
    <div class="grid grid-cols-2 gap-4 mb-8">
        <!-- Watch Time -->
        <div class="bg-dark-900 rounded-xl border border-dark-800 p-5">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"/>
                    </svg>
                </div>
                <div>
                    {% set hours = (stats.total_watch_time_minutes // 60) %}
                    {% set days = hours // 24 %}
                    <p class="text-2xl font-bold text-white">{% if days > 0 %}{{ days }}d {{ hours % 24 }}h{% else %}{{ hours }}h{% endif %}</p>
                    <p class="text-dark-400 text-sm">Watch Time</p>
                </div>
            </div>
        </div>

        <!-- Pages Read -->
        <div class="bg-dark-900 rounded-xl border border-dark-800 p-5">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                </div>
                <div>
                    <p class="text-2xl font-bold text-white">{{ "{:,}".format(stats.total_pages_read) }}</p>
                    <p class="text-dark-400 text-sm">Pages Read</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Media by Type (Doughnut Chart) -->
        <div class="bg-dark-900 rounded-xl border border-dark-800 p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Media by Type</h2>
            <div class="relative h-64">
                <canvas id="typeChart"></canvas>
            </div>
        </div>

        <!-- Media by Status (Doughnut Chart) -->
        <div class="bg-dark-900 rounded-xl border border-dark-800 p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Media by Status</h2>
            <div class="relative h-64">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Monthly Activity (Bar Chart) -->
    <div class="bg-dark-900 rounded-xl border border-dark-800 p-6 mb-8">
        <h2 class="text-lg font-semibold text-white mb-4">Monthly Activity</h2>
        <div class="relative h-72">
            <canvas id="activityChart"></canvas>
        </div>
        {% if not stats.monthly_activity %}
        <p class="text-dark-400 text-center py-8">No activity data yet</p>
        {% endif %}
    </div>

    <!-- Two Column Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Top Genres -->
        <div class="bg-dark-900 rounded-xl border border-dark-800 p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Top Genres</h2>
            {% if stats.top_genres %}
            <div class="space-y-3">
                {% for genre in stats.top_genres %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="w-6 h-6 bg-dark-800 rounded-full flex items-center justify-center text-xs text-dark-400">{{ loop.index }}</span>
                        <span class="text-white">{{ genre.name }}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-24 h-2 bg-dark-800 rounded-full overflow-hidden">
                            <div class="h-full bg-primary-500 rounded-full" style="width: {{ (genre.count / stats.top_genres[0].count * 100) | int }}%"></div>
                        </div>
                        <span class="text-dark-400 text-sm w-8 text-right">{{ genre.count }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-dark-400 text-center py-8">No genre data yet</p>
            {% endif %}
        </div>

        <!-- Rating Distribution -->
        <div class="bg-dark-900 rounded-xl border border-dark-800 p-6">
            <h2 class="text-lg font-semibold text-white mb-4">Rating Distribution</h2>
            <div class="relative h-48">
                <canvas id="ratingChart"></canvas>
            </div>
            {% if not stats.rating_distribution %}
            <p class="text-dark-400 text-center py-8">No ratings yet</p>
            {% endif %}
        </div>
    </div>

    <!-- Release Years -->
    <div class="bg-dark-900 rounded-xl border border-dark-800 p-6">
        <h2 class="text-lg font-semibold text-white mb-4">Media by Release Year</h2>
        <div class="relative h-64">
            <canvas id="yearChart"></canvas>
        </div>
        {% if not stats.by_release_year %}
        <p class="text-dark-400 text-center py-8">No release year data yet</p>
        {% endif %}
    </div>
</div>

<script>
function statsPage(data) {
    return {
        data: data,
        charts: {},

        init() {
            this.$nextTick(() => this.renderCharts());
        },

        renderCharts() {
            if (!this.data) return;

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#9ca3af',
                            font: { size: 12 }
                        }
                    }
                }
            };

            // Destroy existing charts
            Object.values(this.charts).forEach(chart => chart?.destroy?.());

            // Type Chart (Doughnut)
            if (this.data.by_type?.length) {
                const typeCtx = document.getElementById('typeChart');
                this.charts.type = new Chart(typeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: this.data.by_type.map(t => t.label),
                        datasets: [{
                            data: this.data.by_type.map(t => t.count),
                            backgroundColor: this.data.by_type.map(t => t.color),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        ...chartOptions,
                        cutout: '60%',
                        plugins: {
                            ...chartOptions.plugins,
                            legend: {
                                position: 'right',
                                labels: { color: '#9ca3af', padding: 15 }
                            }
                        }
                    }
                });
            }

            // Status Chart (Doughnut)
            if (this.data.by_status?.length) {
                const statusColors = {
                    'to_consume': '#6b7280',
                    'in_progress': '#eab308',
                    'finished': '#22c55e',
                    'abandoned': '#ef4444'
                };
                const statusCtx = document.getElementById('statusChart');
                this.charts.status = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: this.data.by_status.map(s => s.label),
                        datasets: [{
                            data: this.data.by_status.map(s => s.count),
                            backgroundColor: this.data.by_status.map(s => statusColors[s.status] || '#6b7280'),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        ...chartOptions,
                        cutout: '60%',
                        plugins: {
                            ...chartOptions.plugins,
                            legend: {
                                position: 'right',
                                labels: { color: '#9ca3af', padding: 15 }
                            }
                        }
                    }
                });
            }

            // Monthly Activity Chart (Bar)
            if (this.data.monthly_activity?.length) {
                const activityCtx = document.getElementById('activityChart');
                this.charts.activity = new Chart(activityCtx, {
                    type: 'bar',
                    data: {
                        labels: this.data.monthly_activity.map(m => {
                            const [year, month] = m.month.split('-');
                            return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                        }),
                        datasets: [
                            {
                                label: 'Added',
                                data: this.data.monthly_activity.map(m => m.added),
                                backgroundColor: '#6366f1',
                                borderRadius: 4
                            },
                            {
                                label: 'Finished',
                                data: this.data.monthly_activity.map(m => m.finished),
                                backgroundColor: '#22c55e',
                                borderRadius: 4
                            }
                        ]
                    },
                    options: {
                        ...chartOptions,
                        scales: {
                            x: {
                                ticks: { color: '#6b7280' },
                                grid: { color: '#1f2937' }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#6b7280', stepSize: 1 },
                                grid: { color: '#1f2937' }
                            }
                        }
                    }
                });
            }

            // Rating Distribution Chart (Bar)
            if (this.data.rating_distribution?.length) {
                const ratingCtx = document.getElementById('ratingChart');
                // Fill in missing ratings (1-10)
                const ratingData = Array.from({ length: 10 }, (_, i) => {
                    const rating = i + 1;
                    const found = this.data.rating_distribution.find(r => Math.floor(r.rating) === rating);
                    return found?.count || 0;
                });

                this.charts.rating = new Chart(ratingCtx, {
                    type: 'bar',
                    data: {
                        labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
                        datasets: [{
                            label: 'Count',
                            data: ratingData,
                            backgroundColor: '#eab308',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        ...chartOptions,
                        plugins: {
                            ...chartOptions.plugins,
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#6b7280' },
                                grid: { display: false }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#6b7280', stepSize: 1 },
                                grid: { color: '#1f2937' }
                            }
                        }
                    }
                });
            }

            // Release Year Chart (Bar)
            if (this.data.by_release_year?.length) {
                const yearCtx = document.getElementById('yearChart');
                this.charts.year = new Chart(yearCtx, {
                    type: 'bar',
                    data: {
                        labels: this.data.by_release_year.map(y => y.year.toString()),
                        datasets: [{
                            label: 'Media',
                            data: this.data.by_release_year.map(y => y.count),
                            backgroundColor: '#6366f1',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        ...chartOptions,
                        plugins: {
                            ...chartOptions.plugins,
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#6b7280' },
                                grid: { display: false }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#6b7280', stepSize: 1 },
                                grid: { color: '#1f2937' }
                            }
                        }
                    }
                });
            }
        }
    }
}
</script>
{% endblock %}
