{% extends "base.html" %}

{% block title %}Settings - Yaad{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-white">Settings</h1>
        <p class="text-dark-400 mt-1">Manage your account and preferences.</p>
    </div>

    <!-- Profile Section -->
    <div class="bg-dark-900 rounded-xl border border-dark-800 p-6 mb-6">
        <h2 class="text-lg font-semibold text-white mb-4">Profile</h2>
        <div class="flex items-center gap-4">
            {% if user.avatar_url %}
            <img src="{{ user.avatar_url }}" alt="{{ user.username }}" class="w-16 h-16 rounded-full object-cover" referrerpolicy="no-referrer">
            {% else %}
            <div class="w-16 h-16 rounded-full bg-primary-600 flex items-center justify-center">
                <span class="text-2xl font-medium text-white">{{ user.username[0]|upper }}</span>
            </div>
            {% endif %}
            <div>
                <p class="text-white font-medium">{{ user.username }}</p>
                {% if user.email %}
                <p class="text-dark-400 text-sm">{{ user.email }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Connected Accounts -->
    <div class="bg-dark-900 rounded-xl border border-dark-800 p-6 mb-6">
        <h2 class="text-lg font-semibold text-white mb-4">Connected Accounts</h2>
        <div class="space-y-4">
            <!-- GitHub -->
            <div class="flex items-center justify-between py-3 border-b border-dark-800">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-white">GitHub</span>
                </div>
                {% if user.github_id %}
                <span class="text-green-400 text-sm">Connected</span>
                {% else %}
                <a href="/api/auth/github/login" class="text-primary-500 hover:text-primary-400 text-sm">Connect</a>
                {% endif %}
            </div>

            <!-- Google -->
            <div class="flex items-center justify-between py-3">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span class="text-white">Google</span>
                </div>
                {% if user.google_id %}
                <span class="text-green-400 text-sm">Connected</span>
                {% else %}
                <a href="/api/auth/google/login" class="text-primary-500 hover:text-primary-400 text-sm">Connect</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Streaming Preferences -->
    <div class="bg-dark-900 rounded-xl border border-dark-800 p-6 mb-6" x-data="streamingPreferences()">
        <h2 class="text-lg font-semibold text-white mb-4">Streaming Platforms</h2>
        <p class="text-dark-400 text-sm mb-6">Select your country and streaming services to see where movies and series are available.</p>

        <!-- Country Selection -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-dark-300 mb-2">Country</label>
            <select x-model="country" @change="updateCountry()"
                    class="w-full sm:w-64 px-4 py-2.5 bg-dark-800 border border-dark-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                <option value="FR">France</option>
                <option value="US">United States</option>
                <option value="GB">United Kingdom</option>
                <option value="DE">Germany</option>
                <option value="ES">Spain</option>
                <option value="IT">Italy</option>
                <option value="CA">Canada</option>
                <option value="AU">Australia</option>
                <option value="JP">Japan</option>
                <option value="BR">Brazil</option>
                <option value="BE">Belgium</option>
                <option value="CH">Switzerland</option>
                <option value="NL">Netherlands</option>
            </select>
        </div>

        <!-- Streaming Platforms Grid -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-dark-300 mb-3">My Streaming Services</label>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                {% for provider in available_providers %}
                <label class="relative cursor-pointer group">
                    <input type="checkbox"
                           value="{{ provider.provider_id }}"
                           x-model="selectedPlatforms"
                           @change="savePlatforms()"
                           class="peer sr-only">
                    <div class="flex items-center gap-2 p-3 bg-dark-800 border-2 rounded-lg transition-all
                                peer-checked:border-primary-500 peer-checked:bg-primary-500/10
                                border-dark-700 hover:border-dark-600
                                group-hover:shadow-lg">
                        {% if provider.logo_path %}
                        <img src="{{ provider.logo_path }}" alt="{{ provider.provider_name }}" class="w-8 h-8 rounded object-cover flex-shrink-0">
                        {% else %}
                        <div class="w-8 h-8 rounded bg-dark-700 flex items-center justify-center flex-shrink-0">
                            <span class="text-xs text-dark-400">{{ provider.provider_name[:2] }}</span>
                        </div>
                        {% endif %}
                        <span class="text-sm text-white truncate">{{ provider.provider_name }}</span>
                    </div>
                    <!-- Checkmark indicator -->
                    <div class="absolute top-1 right-1 w-5 h-5 bg-primary-500 rounded-full items-center justify-center hidden peer-checked:flex">
                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                </label>
                {% endfor %}
            </div>
        </div>

        <!-- Save Status -->
        <div class="flex items-center gap-2 text-sm" x-show="saveStatus" x-transition>
            <template x-if="saveStatus === 'saving'">
                <span class="text-dark-400">
                    <svg class="w-4 h-4 animate-spin inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle>
                        <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path>
                    </svg>
                    Saving...
                </span>
            </template>
            <template x-if="saveStatus === 'saved'">
                <span class="text-green-400">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Saved
                </span>
            </template>
            <template x-if="saveStatus === 'error'">
                <span class="text-red-400">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Error saving
                </span>
            </template>
        </div>
    </div>

    <!-- Integrations (Phase 4+) -->
    <div class="bg-dark-900 rounded-xl border border-dark-800 p-6 mb-6">
        <h2 class="text-lg font-semibold text-white mb-4">Integrations</h2>
        <div class="space-y-4">
            <!-- Jellyfin -->
            <div class="flex items-center justify-between py-3 border-b border-dark-800">
                <div>
                    <p class="text-white">Jellyfin</p>
                    <p class="text-dark-500 text-sm">Sync watch history from your Jellyfin server</p>
                </div>
                <span class="text-dark-500 text-sm">Coming soon</span>
            </div>

            <!-- Kobo -->
            <div class="flex items-center justify-between py-3">
                <div>
                    <p class="text-white">Kobo</p>
                    <p class="text-dark-500 text-sm">Import reading progress and annotations</p>
                </div>
                <span class="text-dark-500 text-sm">Coming soon</span>
            </div>
        </div>
    </div>

    <!-- Danger Zone -->
    <div class="bg-dark-900 rounded-xl border border-red-900/50 p-6">
        <h2 class="text-lg font-semibold text-red-400 mb-4">Danger Zone</h2>
        <div class="flex items-center justify-between">
            <div>
                <p class="text-white">Delete Account</p>
                <p class="text-dark-500 text-sm">Permanently delete your account and all data</p>
            </div>
            <button disabled
                    class="px-4 py-2 bg-red-600/20 text-red-400 rounded-lg cursor-not-allowed opacity-50">
                Delete Account
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function streamingPreferences() {
    return {
        country: '{{ user_country }}',
        selectedPlatforms: {{ user_providers | tojson }}.map(String),
        saveStatus: null,
        saveTimeout: null,

        async updateCountry() {
            this.saveStatus = 'saving';
            try {
                const response = await fetch('/api/user/streaming-preferences', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ country: this.country })
                });

                if (response.ok) {
                    this.saveStatus = 'saved';
                    // Reload page to get new providers for the country
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    this.saveStatus = 'error';
                }
            } catch (e) {
                this.saveStatus = 'error';
            }

            this.clearStatusAfterDelay();
        },

        async savePlatforms() {
            // Debounce saves
            if (this.saveTimeout) {
                clearTimeout(this.saveTimeout);
            }

            this.saveTimeout = setTimeout(async () => {
                this.saveStatus = 'saving';
                try {
                    const platforms = this.selectedPlatforms.map(p => parseInt(p));
                    const response = await fetch('/api/user/streaming-preferences', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ streaming_platforms: platforms })
                    });

                    if (response.ok) {
                        this.saveStatus = 'saved';
                    } else {
                        this.saveStatus = 'error';
                    }
                } catch (e) {
                    this.saveStatus = 'error';
                }

                this.clearStatusAfterDelay();
            }, 300);
        },

        clearStatusAfterDelay() {
            setTimeout(() => {
                this.saveStatus = null;
            }, 2000);
        }
    }
}
</script>
{% endblock %}
