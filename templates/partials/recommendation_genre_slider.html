{# Netflix-style horizontal genre slider for recommendations #}
<div class="mb-8" x-data="genreSlider_{{ genre|replace(' ', '_')|replace('/', '_')|replace('-', '_') }}()">
    <!-- Genre Header with hover effect -->
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-slate-300 hover:text-white transition-colors cursor-default group flex items-center gap-2">
            {{ genre }}
            <svg class="w-4 h-4 text-slate-500 opacity-0 group-hover:opacity-100 group-hover:translate-x-1 transition-all duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
        </h3>
        <span class="text-xs text-slate-600">{{ recs|length }} titles</span>
    </div>

    <!-- Slider Container with Netflix-style navigation -->
    <div class="relative group/slider">
        <!-- Left Navigation Button (Netflix style) -->
        <button type="button"
                @click="scrollLeft()"
                x-show="canScrollLeft"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="slider-nav-btn absolute left-0 top-0 bottom-0 w-12 z-20 flex items-center justify-center bg-slate-950/80 hover:bg-slate-950/95 opacity-0 group-hover/slider:opacity-100 transition-all duration-300 cursor-pointer rounded-l-xl">
            <svg class="w-7 h-7 text-white transition-transform duration-150 hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/>
            </svg>
        </button>

        <!-- Right Navigation Button (Netflix style) -->
        <button type="button"
                @click="scrollRight()"
                x-show="canScrollRight"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="slider-nav-btn absolute right-0 top-0 bottom-0 w-12 z-20 flex items-center justify-center bg-slate-950/80 hover:bg-slate-950/95 opacity-0 group-hover/slider:opacity-100 transition-all duration-300 cursor-pointer rounded-r-xl">
            <svg class="w-7 h-7 text-white transition-transform duration-150 hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"/>
            </svg>
        </button>

        <!-- Scroll Container with drag support -->
        <div class="overflow-hidden">
            <div x-ref="slider"
                 :style="'transform: translateX(' + (-currentOffset) + 'px); transition: transform ' + (isDragging ? '0ms' : '600ms') + ' cubic-bezier(0.25, 0.1, 0.25, 1);'"
                 @mousedown="startDrag($event)"
                 @mousemove="onDrag($event)"
                 @mouseup="endDrag()"
                 @mouseleave="endDrag()"
                 :class="isDragging ? 'cursor-grabbing' : 'cursor-grab'"
                 class="flex gap-4 pb-2 select-none">
                {% for rec in recs %}
                <!-- Recommendation Card -->
                <div class="reco-tile flex-shrink-0 group/card {% if rec.is_streamable %}streamable-card{% endif %}"
                     data-rec-id="{{ rec.id }}">
                    <div class="reco-card-inner bg-slate-900 rounded-xl overflow-hidden relative">
                        <!-- Cover -->
                        <div class="{% if rec.media_type.value in ['youtube'] %}aspect-video{% else %}aspect-[2/3]{% endif %} relative overflow-hidden bg-slate-800 cursor-pointer"
                             @click="openModal({{ rec.id }})">
                            {% if rec.cover_url %}
                            <img src="{{ rec.cover_url }}"
                                 alt="{{ rec.title }}"
                                 class="w-full h-full object-cover transition-transform duration-500 group-hover/card:scale-110"
                                 loading="lazy"
                                 draggable="false">
                            {% else %}
                            <!-- Placeholder -->
                            <div class="w-full h-full flex items-center justify-center
                                {% if rec.media_type.value == 'film' %}bg-gradient-to-br from-blue-600/30 to-blue-900/30
                                {% elif rec.media_type.value == 'series' %}bg-gradient-to-br from-cyan-600/30 to-cyan-900/30
                                {% elif rec.media_type.value == 'book' %}bg-gradient-to-br from-emerald-600/30 to-emerald-900/30
                                {% elif rec.media_type.value == 'youtube' %}bg-gradient-to-br from-red-600/30 to-red-900/30
                                {% endif %}">
                                <span class="text-3xl font-bold text-white/40">{{ rec.title[0] }}</span>
                            </div>
                            {% endif %}

                            <!-- Gradient overlay at bottom -->
                            <div class="absolute inset-x-0 bottom-0 h-28 bg-gradient-to-t from-slate-900 via-slate-900/70 to-transparent pointer-events-none"></div>

                            <!-- TMDB Rating Badge (top right) -->
                            {% if rec.tmdb_rating %}
                            <div class="absolute top-2 right-2 px-2 py-1 bg-black/70 backdrop-blur-sm rounded-lg text-xs font-bold text-white flex items-center gap-1">
                                <svg class="w-3.5 h-3.5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                                {{ "%.1f"|format(rec.tmdb_rating) }}
                            </div>
                            {% endif %}

                            <!-- Streaming Badge (top left) - priority over source -->
                            {% if rec.is_streamable %}
                            <div class="absolute top-2 left-2 px-2 py-1 rounded-lg text-[10px] font-semibold uppercase tracking-wide bg-emerald-500/90 text-white flex items-center gap-1" title="{{ rec.streaming_providers|join(', ') if rec.streaming_providers else 'Streaming' }}">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                                </svg>
                                Stream
                            </div>
                            {% else %}
                            <!-- Source Badge (top left) -->
                            <div class="absolute top-2 left-2 px-2 py-1 rounded-lg text-[10px] font-semibold uppercase tracking-wide
                                {% if rec.source == 'similar' %}bg-purple-500/90 text-white
                                {% elif rec.source == 'trending' %}bg-orange-500/90 text-white
                                {% elif rec.source == 'genre_match' or rec.source == 'genre_discover' %}bg-blue-500/90 text-white
                                {% else %}bg-slate-700/90 text-slate-300
                                {% endif %}">
                                {% if rec.source == 'similar' %}Similar
                                {% elif rec.source == 'trending' %}Trending
                                {% elif rec.source == 'genre_match' or rec.source == 'genre_discover' %}For You
                                {% elif rec.source == 'same_author' %}Same Author
                                {% elif rec.source == 'favorite_channel' %}Favorite
                                {% else %}{{ rec.source }}
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- Info overlay at bottom of cover -->
                            <div class="absolute bottom-0 left-0 right-0 p-3 pointer-events-none">
                                <h4 class="text-sm font-semibold text-white truncate leading-tight" title="{{ rec.title }}">{{ rec.title }}</h4>
                                <div class="flex items-center gap-2 mt-1">
                                    {% if rec.year %}
                                    <span class="text-xs text-slate-400">{{ rec.year }}</span>
                                    {% endif %}
                                    <!-- Match percentage -->
                                    <span class="text-xs text-purple-400 font-medium">{{ "%.0f"|format(rec.score * 100) }}%</span>
                                </div>
                            </div>

                            <!-- Play/View Overlay (on hover) -->
                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover/card:opacity-100 transition-all duration-300 flex items-center justify-center pointer-events-none">
                                <div class="w-14 h-14 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center transform scale-75 group-hover/card:scale-100 transition-transform duration-300">
                                    <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons (always visible at bottom) -->
                        <div class="flex gap-2 p-2 bg-slate-900">
                            <!-- Add Button -->
                            <button @click.stop="
                                fetch('/api/recommendations/{{ rec.id }}/add', { method: 'POST' })
                                    .then(r => { if(r.ok) $el.closest('[data-rec-id]').classList.add('animate-slide-out'); setTimeout(() => $el.closest('[data-rec-id]').remove(), 300) })
                            "
                                    class="flex-1 py-2.5 bg-emerald-500 hover:bg-emerald-400 rounded-lg text-white text-sm font-semibold transition-all duration-200 flex items-center justify-center gap-1.5 shadow-lg hover:shadow-emerald-500/25 hover:scale-[1.02] active:scale-[0.98]">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/>
                                </svg>
                                Add
                            </button>
                            <!-- Dismiss Button -->
                            <button @click.stop="
                                fetch('/api/recommendations/{{ rec.id }}/dismiss', { method: 'POST' })
                                    .then(r => { if(r.ok) $el.closest('[data-rec-id]').classList.add('animate-slide-out'); setTimeout(() => $el.closest('[data-rec-id]').remove(), 300) })
                            "
                                    class="w-12 py-2.5 bg-red-500/80 hover:bg-red-500 rounded-lg text-white transition-all duration-200 flex items-center justify-center shadow-lg hover:shadow-red-500/25 hover:scale-[1.02] active:scale-[0.98]">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
    /* Tile sizing - responsive */
    .reco-tile {
        width: calc((100% - 64px) / 5);
        min-width: 160px;
    }
    @media (max-width: 1279px) {
        .reco-tile { width: calc((100% - 48px) / 4); }
    }
    @media (max-width: 1023px) {
        .reco-tile { width: calc((100% - 32px) / 3); }
    }
    @media (max-width: 767px) {
        .reco-tile { width: calc((100% - 16px) / 2); min-width: 140px; }
    }

    /* Streamable card - green border like catalogue */
    .streamable-card {
        border: 4px solid #22c55e;
        border-radius: 0.85rem;
    }
    .streamable-card .reco-card-inner {
        border-radius: 0.6rem;
    }

    /* Card hover effects - GPU accelerated */
    .reco-card-inner {
        transition: transform 0.35s ease-out, box-shadow 0.35s ease-out;
    }
    .reco-tile:hover .reco-card-inner {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.5);
    }
    .streamable-card:hover {
        box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
    }

    /* Slide out animation for removed cards */
    @keyframes slideOut {
        to {
            opacity: 0;
            transform: scale(0.8) translateY(-20px);
        }
    }
    .animate-slide-out {
        animation: slideOut 0.3s ease-out forwards;
    }

    /* Nav button hover effects */
    .slider-nav-btn:hover svg {
        transform: scale(1.15);
    }
    .slider-nav-btn:active svg {
        transform: scale(0.95);
    }
</style>

<script>
function genreSlider_{{ genre|replace(' ', '_')|replace('/', '_')|replace('-', '_') }}() {
    return {
        isDragging: false,
        wasDragging: false,
        startX: 0,
        offsetStart: 0,
        canScrollLeft: false,
        canScrollRight: true,
        currentOffset: 0,
        velocity: 0,
        lastX: 0,
        lastTime: 0,

        init() {
            this.$nextTick(() => {
                this.updateScrollState();
            });
        },

        getMaxOffset() {
            const slider = this.$refs.slider;
            if (!slider) return 0;
            return Math.max(0, slider.scrollWidth - slider.parentElement.clientWidth);
        },

        getVisibleWidth() {
            const slider = this.$refs.slider;
            return slider?.parentElement?.clientWidth || 0;
        },

        updateScrollState() {
            const maxOffset = this.getMaxOffset();
            this.canScrollLeft = this.currentOffset > 10;
            this.canScrollRight = this.currentOffset < maxOffset - 10;
        },

        scrollLeft() {
            const scrollAmount = this.getVisibleWidth() * 0.8;
            this.currentOffset = Math.max(0, this.currentOffset - scrollAmount);
            this.updateScrollState();
        },

        scrollRight() {
            const maxOffset = this.getMaxOffset();
            const scrollAmount = this.getVisibleWidth() * 0.8;
            this.currentOffset = Math.min(maxOffset, this.currentOffset + scrollAmount);
            this.updateScrollState();
        },

        startDrag(e) {
            if (e.button !== 0) return;
            this.isDragging = true;
            this.wasDragging = false;
            this.startX = e.pageX;
            this.offsetStart = this.currentOffset;
            this.lastX = e.pageX;
            this.lastTime = performance.now();
            this.velocity = 0;
        },

        onDrag(e) {
            if (!this.isDragging) return;
            e.preventDefault();
            const x = e.pageX;
            const walk = (this.startX - x) * 1.2;
            const now = performance.now();
            const dt = now - this.lastTime;
            if (dt > 0 && dt < 50) {
                const instantVelocity = (this.lastX - x) / dt;
                this.velocity = this.velocity * 0.7 + instantVelocity * 0.3;
            }
            this.lastX = x;
            this.lastTime = now;
            const maxOffset = this.getMaxOffset();
            this.currentOffset = Math.max(0, Math.min(maxOffset, this.offsetStart + walk));
            if (Math.abs(walk) > 5) {
                this.wasDragging = true;
            }
            this.updateScrollState();
        },

        endDrag() {
            if (!this.isDragging) return;
            this.isDragging = false;
            // Apply momentum
            if (Math.abs(this.velocity) > 0.3) {
                const maxOffset = this.getMaxOffset();
                const momentumDistance = this.velocity * 200;
                this.currentOffset = Math.max(0, Math.min(maxOffset, this.currentOffset + momentumDistance));
            }
            this.updateScrollState();
            setTimeout(() => { this.wasDragging = false; }, 50);
        }
    }
}
</script>
